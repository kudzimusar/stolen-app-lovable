name: STOLEN Platform - Coherence Enforcement

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  coherence-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Coherence Analysis
      run: npm run coherence:ai-all
      env:
        # Production AI API keys (stored as GitHub secrets)
        NVIDIA_NIM_API_KEY: ${{ secrets.NVIDIA_NIM_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        
    - name: Generate Coherence Report
      run: |
        mkdir -p coherence-reports
        npm run coherence:ai-all > coherence-reports/analysis-$(date +%Y%m%d-%H%M%S).txt
        
    - name: Upload Coherence Reports
      uses: actions/upload-artifact@v4
      with:
        name: coherence-reports
        path: coherence-reports/
        
    - name: Comment PR with Coherence Analysis
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Read the latest coherence report
          const reportsDir = 'coherence-reports';
          const files = fs.readdirSync(reportsDir);
          const latestReport = files.sort().pop();
          const reportContent = fs.readFileSync(path.join(reportsDir, latestReport), 'utf8');
          
          // Create comment
          const comment = `## üîç STOLEN Platform Coherence Analysis
          
          \`\`\`
          ${reportContent}
          \`\`\`
          
          **Analysis completed for PR #${{ github.event.pull_request.number }}**
          
          This analysis ensures code changes maintain coherence across the 8-stakeholder ecosystem.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: Fail on Critical Issues
      run: |
        # Check if there are any critical issues in the analysis
        if grep -q "üî¥ Critical" coherence-reports/*.txt; then
          echo "‚ùå Critical coherence issues detected. Build failed."
          exit 1
        else
          echo "‚úÖ No critical coherence issues detected."
        fi
